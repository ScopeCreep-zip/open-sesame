name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  pages: write
  id-token: write
  attestations: write

env:
  CARGO_TERM_COLOR: always

jobs:
  # ==========================================================================
  # Build .deb packages for each architecture
  # ==========================================================================
  build:
    name: Build ${{ matrix.arch }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            build_task: ci:build:deb
            rename_task: ci:release:rename-deb
          - arch: arm64
            runner: ubuntu-24.04-arm
            build_task: ci:build:deb:arm64
            rename_task: ci:release:rename-deb:arm64
    runs-on: ${{ matrix.runner }}

    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust cargo:cargo-deb"
          cache: true

      - run: mise run ${{ matrix.build_task }}

      - run: mise run ${{ matrix.rename_task }}

      - uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: "*.deb"
          retention-days: 1

  # ==========================================================================
  # Generate build attestations for supply chain security
  # ==========================================================================
  attest:
    name: Attest Build Provenance
    needs: build
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - uses: actions/attest-build-provenance@v2
        with:
          subject-path: "*.deb"

  # ==========================================================================
  # Create GitHub Release with .deb assets
  # ==========================================================================
  release:
    name: Create GitHub Release
    needs: build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - id: version
        run: echo "version=${GITHUB_REF_NAME#v}" >> "$GITHUB_OUTPUT"

      - uses: softprops/action-gh-release@v2
        with:
          files: "*.deb"
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref_name, '-') }}

  # ==========================================================================
  # Build documentation (rustdoc + mdBook)
  # ==========================================================================
  build-docs:
    name: Build Documentation
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust"
          cache: true

      - run: mise run ci:docs:all

      - run: mise run ci:docs:combine

      - uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: combined-docs/
          retention-days: 1

  # ==========================================================================
  # Generate and deploy APT repository + documentation to GitHub Pages
  # ==========================================================================
  publish-apt:
    name: Publish APT Repository & Documentation
    needs: [build, release, build-docs]
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          path: packages/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: documentation
          path: docs-site/

      - uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust"
          cache: true

      - env:
          VERSION: ${{ needs.release.outputs.version }}
          REPO_URL: https://github.com/${{ github.repository }}/releases/download
        run: mise run ci:release:apt-repo

      - uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages/

      - id: deployment
        uses: actions/deploy-pages@v4

  # ==========================================================================
  # Cleanup old releases (keep last 10)
  # ==========================================================================
  cleanup:
    name: Cleanup Old Releases
    needs: [release, publish-apt]
    runs-on: ubuntu-latest

    steps:
      - uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 10
          delete_tags: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

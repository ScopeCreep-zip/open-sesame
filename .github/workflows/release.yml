name: Release

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      dry-run:
        description: 'Run semantic-release in dry-run mode'
        type: boolean
        default: false

permissions:
  contents: write
  pages: write
  id-token: write
  attestations: write
  issues: write
  pull-requests: write

env:
  CARGO_TERM_COLOR: always
  MISE_AUTO_INSTALL: "false"

jobs:
  # ==========================================================================
  # Semantic Release - analyze commits and create GitHub release with tag
  # ==========================================================================
  semantic-release:
    name: Semantic Release
    runs-on: ubuntu-latest
    outputs:
      new_release: ${{ steps.release.outputs.new_release }}
      version: ${{ steps.release.outputs.version }}
      tag: ${{ steps.release.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: false

      - uses: actions/setup-node@v4
        with:
          node-version: '22'

      - name: Install semantic-release plugins
        run: |
          npm install --no-save \
            semantic-release@24.2.9 \
            @semantic-release/git@10.0.1 \
            @semantic-release/changelog@6.0.3 \
            @semantic-release/exec@7.1.0 \
            @semantic-release/commit-analyzer@13.0.1 \
            @semantic-release/release-notes-generator@14.1.0 \
            @semantic-release/github@11.0.6 \
            conventional-changelog-conventionalcommits@9.1.0

      - name: Semantic Release
        id: release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if [[ "${{ inputs.dry-run }}" == "true" ]]; then
            npx semantic-release --dry-run 2>&1 | tee release-output.txt
            echo "new_release=false" >> "$GITHUB_OUTPUT"
          else
            npx semantic-release 2>&1 | tee release-output.txt
            if grep -q "Published release" release-output.txt; then
              VERSION=$(grep -oP 'Published release \K[0-9]+\.[0-9]+\.[0-9]+' release-output.txt || true)
              echo "new_release=true" >> "$GITHUB_OUTPUT"
              echo "version=${VERSION}" >> "$GITHUB_OUTPUT"
              echo "tag=v${VERSION}" >> "$GITHUB_OUTPUT"
            else
              echo "new_release=false" >> "$GITHUB_OUTPUT"
            fi
          fi

  # ==========================================================================
  # Build .deb packages for each architecture
  # ==========================================================================
  build:
    name: Build ${{ matrix.arch }}
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - arch: amd64
            runner: ubuntu-24.04
            build_task: ci:build:deb
            rename_task: ci:release:rename-deb
          - arch: arm64
            runner: ubuntu-24.04-arm
            build_task: ci:build:deb:arm64
            rename_task: ci:release:rename-deb:arm64
    runs-on: ${{ matrix.runner }}
    env:
      GITHUB_REF_NAME: ${{ needs.semantic-release.outputs.tag }}

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.semantic-release.outputs.tag }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust cargo:cargo-deb"
          cache: true

      - run: mise run ${{ matrix.build_task }}

      - run: mise run ${{ matrix.rename_task }}

      - uses: actions/upload-artifact@v4
        with:
          name: deb-${{ matrix.arch }}
          path: "*.deb"
          retention-days: 1

  # ==========================================================================
  # Generate build attestations for supply chain security
  # ==========================================================================
  attest:
    name: Attest Build Provenance
    needs: [semantic-release, build]
    if: needs.semantic-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - uses: actions/attest-build-provenance@v2
        with:
          subject-path: "*.deb"

  # ==========================================================================
  # Upload .deb assets to GitHub Release
  # ==========================================================================
  upload-assets:
    name: Upload Release Assets
    needs: [semantic-release, build]
    if: needs.semantic-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ needs.semantic-release.outputs.version }}
      TAG: ${{ needs.semantic-release.outputs.tag }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          merge-multiple: true

      - name: Generate checksums and install instructions
        run: |
          sha256sum *.deb > SHA256SUMS.txt
          cat SHA256SUMS.txt
          SHA_X86_64=$(grep linux-x86_64 SHA256SUMS.txt | cut -d' ' -f1)
          SHA_AARCH64=$(grep linux-aarch64 SHA256SUMS.txt | cut -d' ' -f1)
          sed -e "s/\${TAG}/${TAG}/g" \
              -e "s/\${VERSION}/${VERSION}/g" \
              -e "s/\${SHA256_X86_64}/${SHA_X86_64}/g" \
              -e "s/\${SHA256_AARCH64}/${SHA_AARCH64}/g" \
              .github/templates/RELEASE_BODY.md > install_instructions.md

      - name: Upload assets to release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ env.TAG }}
          files: |
            *.deb
            SHA256SUMS.txt
          body_path: install_instructions.md
          append_body: true

  # ==========================================================================
  # Build documentation (rustdoc + mdBook)
  # ==========================================================================
  build-docs:
    name: Build Documentation
    needs: semantic-release
    if: needs.semantic-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          ref: ${{ needs.semantic-release.outputs.tag }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust"
          cache: true

      - run: mise run ci:docs:all

      - run: mise run ci:docs:combine

      - uses: actions/upload-artifact@v4
        with:
          name: documentation
          path: combined-docs/
          retention-days: 1

  # ==========================================================================
  # Generate and deploy APT repository + documentation to GitHub Pages
  # ==========================================================================
  publish:
    name: Publish APT Repository & Docs
    needs: [semantic-release, build, upload-assets, build-docs]
    if: needs.semantic-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - uses: actions/checkout@v4

      - uses: actions/download-artifact@v4
        with:
          pattern: deb-*
          path: packages/
          merge-multiple: true

      - uses: actions/download-artifact@v4
        with:
          name: documentation
          path: docs-site/

      - uses: crazy-max/ghaction-import-gpg@v6
        with:
          gpg_private_key: ${{ secrets.GPG_PRIVATE_KEY }}

      - uses: jdx/mise-action@v3
        with:
          install_args: "rust"
          cache: true

      - run: mise run ci:release:apt-repo

      - uses: actions/upload-pages-artifact@v3
        with:
          path: gh-pages/

      - id: deployment
        uses: actions/deploy-pages@v4

  # ==========================================================================
  # Cleanup old releases (keep last 10)
  # ==========================================================================
  cleanup:
    name: Cleanup Old Releases
    needs: [semantic-release, publish]
    if: needs.semantic-release.outputs.new_release == 'true'
    runs-on: ubuntu-latest

    steps:
      - uses: dev-drprasad/delete-older-releases@v0.3.4
        with:
          keep_latest: 10
          delete_tags: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
